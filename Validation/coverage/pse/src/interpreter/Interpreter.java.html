<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>Interpreter.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Merged (26.02.2012 19:54:06)</a> &gt; <a href="../../index.html" class="el_group">pse</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.html" class="el_package">interpreter</a> &gt; <span class="el_source">Interpreter.java</span></div><h1>Interpreter.java</h1><pre class="source lang-java linenums">package interpreter;

import ast.*;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;

/**
 * This class interprets the user program step by step.
 */
<span class="fc" id="L12">public class Interpreter implements ASTVisitor {</span>
    /**
     * temporarily saved value
     */
    private Value tempValue;
    /**
     * temporarily saved state
     */
    private State currentState;
    /**
     * temporarily saved return value
     */
    private Value returnValue;
    /**
     * temporarily saved function call parameters
     */
    private Value[] parameters;

    /**
     * exception to stop the execution of a statement in case of a
     * function call
     */
<span class="fc" id="L34">    private static class StopStatementException extends RuntimeException {</span>
    }

    public State step(State state) {
<span class="fc" id="L38">        currentState = state;</span>
        try {
<span class="fc" id="L40">            state.getCurrentStatement().accept(this);</span>
<span class="fc" id="L41">        } catch (StopStatementException ignored) {</span>
            //nothing to do
        }
<span class="fc" id="L44">        return state;</span>
    }

    /**
     * Checks the assumptions, given a specified state.
     * @param state state used to evaluate the assumptions
     * @param assumptions assumtions to evaluate
     */
    public void checkAssumptions(State state, Assumption[] assumptions) {
<span class="fc" id="L53">        currentState = state;</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        for (Assumption assumption : assumptions) {</span>
<span class="nc" id="L55">            assumption.accept(this);</span>
        }
<span class="fc" id="L57">    }</span>

    @Override
    public void visit(Conditional conditional) {
<span class="fc" id="L61">        conditional.getCondition().accept(this);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (((BooleanValue) tempValue).getValue()) {</span>
<span class="fc" id="L63">            currentState.createScope(conditional.getTrueConditionBody(),</span>
<span class="fc" id="L64">                    null);</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">        } else if (conditional.getFalseConditionBody() != null) {</span>
<span class="fc" id="L66">            currentState.createScope(conditional.getFalseConditionBody(),</span>
<span class="fc" id="L67">                    null);</span>
        }
<span class="fc" id="L69">        adjustStatement();</span>
<span class="fc" id="L70">    }</span>

    @Override
    public void visit(Loop loop) {
<span class="fc" id="L74">        loop.getCondition().accept(this);</span>
<span class="fc" id="L75">        boolean condition = ((BooleanValue) tempValue).getValue();</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (condition) {</span>
<span class="fc" id="L77">            currentState.createScope(loop.getLoopBody(),</span>
<span class="fc" id="L78">                                     null);</span>
<span class="fc" id="L79">            adjustStatement();</span>
        }
<span class="fc" id="L81">        Invariant[] invariants = loop.getInvariants();</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">        for (Invariant invariant : invariants) {</span>
<span class="fc" id="L83">            invariant.accept(this);</span>
        }
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (!condition) {</span>
<span class="fc" id="L86">            Ensure[] ensures = loop.getPostconditions();</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">            for (Ensure ensure : ensures) {</span>
<span class="fc" id="L88">                ensure.accept(this);</span>
            }
<span class="fc" id="L90">            adjustStatement();</span>
        }
<span class="fc" id="L92">    }</span>

    @Override
    public void visit(ArrayAssignment arrayAssignment) {
<span class="fc" id="L96">        Expression[] indices = arrayAssignment.getIndices();</span>
<span class="fc" id="L97">        ArrayList&lt;Integer&gt; lengths = new ArrayList&lt;Integer&gt;();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (Expression index : indices) {</span>
<span class="fc" id="L99">            index.accept(this);</span>
<span class="fc" id="L100">            int pos = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="fc" id="L101">            lengths.add(pos);</span>
        }
<span class="fc" id="L103">        arrayAssignment.getValue().accept(this);</span>
<span class="fc" id="L104">        currentState.setArray(arrayAssignment.getIdentifier().toString(),</span>
<span class="fc" id="L105">                              tempValue.toString(), lengths);</span>
<span class="fc" id="L106">        adjustStatement();</span>
<span class="fc" id="L107">    }</span>

    @Override
    public void visit(ArithmeticExpression arithmeticExpression) {
<span class="fc" id="L111">        arithmeticExpression.getSubexpression1().accept(this);</span>
<span class="fc" id="L112">        ArithmeticOperator operator =</span>
<span class="fc" id="L113">                arithmeticExpression.getArithmeticOperator();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (operator instanceof BinaryOperator) {</span>
<span class="fc" id="L115">            BigInteger value1 = ((IntegerValue) tempValue).getValue();</span>
<span class="fc" id="L116">            arithmeticExpression.getSubexpression2().accept(this);</span>
<span class="fc" id="L117">            BigInteger value2 = ((IntegerValue) tempValue).getValue();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">            if (operator instanceof Addition) {</span>
<span class="fc" id="L119">                BigInteger newValue = value1.add(value2);</span>
<span class="fc" id="L120">                tempValue = new IntegerValue(newValue.toString());</span>
            }
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (operator instanceof Subtraction) {</span>
<span class="fc" id="L123">                BigInteger newValue = value1.subtract(value2);</span>
<span class="fc" id="L124">                tempValue = new IntegerValue(newValue.toString());</span>
            }
<span class="fc bfc" id="L126" title="All 2 branches covered.">            if (operator instanceof Multiplication) {</span>
<span class="fc" id="L127">                BigInteger newValue = value1.multiply(value2);</span>
<span class="fc" id="L128">                tempValue = new IntegerValue(newValue.toString());</span>
            }
<span class="fc bfc" id="L130" title="All 2 branches covered.">            if (operator instanceof Division) {</span>
                BigInteger newValue;
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">                if (value2.equals(BigInteger.ZERO)) {</span>
<span class="nc" id="L133">                    newValue = BigInteger.ZERO;</span>
                } else {
<span class="fc" id="L135">                    newValue = divide(value1, value2);</span>
                }
<span class="fc" id="L137">                tempValue = new IntegerValue(newValue.toString());</span>
            }
<span class="fc bfc" id="L139" title="All 2 branches covered.">            if (operator instanceof Modulo) {</span>
                BigInteger newValue;
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">                if (value2.equals(BigInteger.ZERO)) {</span>
<span class="nc" id="L142">                    newValue = value1;</span>
                } else {
<span class="fc" id="L144">                    newValue = value2.multiply(divide(value1, value2));</span>
<span class="fc" id="L145">                    newValue = value1.subtract(newValue);</span>
                }
<span class="fc" id="L147">                tempValue = new IntegerValue(newValue.toString());</span>
            }
        } else {
            //Unary minus
<span class="fc" id="L151">            BigInteger newValue =</span>
<span class="fc" id="L152">                    ((IntegerValue) tempValue).getValue().negate();</span>
<span class="fc" id="L153">            tempValue = new IntegerValue(newValue.toString());</span>
        }
<span class="fc" id="L155">    }</span>

    public static BigInteger divide(BigInteger dividend, BigInteger divisor) {
<span class="fc" id="L158">        BigInteger result = dividend.divide(divisor);</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (dividend.signum() == -1 &amp;&amp;</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">                !dividend.remainder(divisor).equals(BigInteger.ZERO)) {</span>
<span class="fc" id="L161">            result = result.subtract(</span>
<span class="fc" id="L162">                    new BigInteger(divisor.signum(), new byte[]{1}));</span>
        }
<span class="fc" id="L164">        return result;</span>
    }

    @Override
    public void visit(NumericLiteral number) {
<span class="fc" id="L169">        tempValue = number.getValue();</span>
<span class="fc" id="L170">    }</span>

    @Override
    public void visit(LogicalExpression logicalExpression) {
<span class="fc" id="L174">        logicalExpression.getSubexpression1().accept(this);</span>
<span class="fc" id="L175">        LogicalOperator operator = logicalExpression.getLogicalOperator();</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (operator instanceof BinaryOperator) {</span>
<span class="fc" id="L177">            Value tempValue1 = tempValue;</span>
<span class="fc" id="L178">            logicalExpression.getSubexpression2().accept(this);</span>
<span class="fc" id="L179">            Value tempValue2 = tempValue;</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">            if (operator instanceof Disjunction) {</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">                boolean newValue = ((BooleanValue) tempValue1).getValue()</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">                        || ((BooleanValue) tempValue2).getValue();</span>
<span class="fc" id="L183">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L185" title="All 2 branches covered.">            if (operator instanceof Conjunction) {</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">                boolean newValue = ((BooleanValue) tempValue1).getValue()</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">                        &amp;&amp; ((BooleanValue) tempValue2).getValue();</span>
<span class="fc" id="L188">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L190" title="All 2 branches covered.">            if (operator instanceof Greater) {</span>
<span class="fc" id="L191">                boolean newValue =</span>
<span class="fc" id="L192">                        ((IntegerValue) tempValue1).getValue().intValue()</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">                            &gt; ((IntegerValue) tempValue2).getValue().intValue();</span>
<span class="fc" id="L194">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L196" title="All 2 branches covered.">            if (operator instanceof GreaterEqual) {</span>
<span class="fc" id="L197">                boolean newValue =</span>
<span class="fc" id="L198">                        ((IntegerValue) tempValue1).getValue().intValue()</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">                           &gt;= ((IntegerValue) tempValue2).getValue().intValue();</span>
<span class="fc" id="L200">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L202" title="All 2 branches covered.">            if (operator instanceof Less) {</span>
<span class="fc" id="L203">                boolean newValue =</span>
<span class="fc" id="L204">                        ((IntegerValue) tempValue1).getValue().intValue()</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">                            &lt; ((IntegerValue) tempValue2).getValue().intValue();</span>
<span class="fc" id="L206">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L208" title="All 2 branches covered.">            if (operator instanceof LessEqual) {</span>
<span class="fc" id="L209">                boolean newValue =</span>
<span class="fc" id="L210">                        ((IntegerValue) tempValue1).getValue().intValue()</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">                           &lt;= ((IntegerValue) tempValue2).getValue().intValue();</span>
<span class="fc" id="L212">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L214" title="All 2 branches covered.">            if (operator instanceof Equal) {</span>
<span class="fc" id="L215">                boolean newValue = tempValue1.equals(tempValue2);</span>
<span class="fc" id="L216">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
<span class="fc bfc" id="L218" title="All 2 branches covered.">            if (operator instanceof NotEqual) {</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">                boolean newValue = !tempValue1.equals(tempValue2);</span>
<span class="fc" id="L220">                tempValue = new BooleanValue(Boolean.toString(newValue));</span>
            }
        } else {
            //Negation
<span class="nc bnc" id="L224" title="All 2 branches missed.">            boolean newValue = !((BooleanValue) tempValue).getValue();</span>
<span class="nc" id="L225">            tempValue = new BooleanValue(Boolean.toString(newValue));</span>
        }
<span class="fc" id="L227">    }</span>

    @Override
    public void visit(BooleanLiteral bool) {
<span class="fc" id="L231">        tempValue = bool.getValue();</span>
<span class="fc" id="L232">    }</span>

    @Override
    public void visit(FunctionCall functionCall) {
<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (&quot;length&quot;.equals(functionCall.getFunctionIdentifier().toString())) {</span>
<span class="fc" id="L237">            functionCall.getParameters()[0].accept(this);</span>
<span class="fc" id="L238">            int arrayLength = ((ArrayValue) tempValue).getValues().length;</span>
<span class="fc" id="L239">            tempValue = new IntegerValue(Integer.toString(arrayLength));</span>
<span class="fc" id="L240">            return;</span>
        }
<span class="fc" id="L242">        Value value = currentState.getReturnValues().get(functionCall);</span>
<span class="fc bfc" id="L243" title="All 4 branches covered.">        if (value == null &amp;&amp; returnValue != null) {</span>
<span class="fc" id="L244">            currentState.createFunctionResult(functionCall, returnValue);</span>
<span class="fc" id="L245">            value = returnValue;</span>
<span class="fc" id="L246">            returnValue = null;</span>
        }
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (value == null) {</span>
            //result not calculated yet
<span class="fc" id="L250">            Expression[] parameterExpressions = functionCall.getParameters();</span>
<span class="fc" id="L251">            parameters = new Value[parameterExpressions.length];</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">            for (int i = 0; i &lt; parameters.length; i++) {</span>
<span class="fc" id="L253">                parameterExpressions[i].accept(this);</span>
<span class="fc" id="L254">                parameters[i] = tempValue;</span>
            }
<span class="fc" id="L256">            functionCall.getFunction().accept(this);</span>
            //statement must be started again
<span class="fc" id="L258">            throw new StopStatementException();</span>
        } else {
<span class="fc" id="L260">            tempValue = value;</span>
        }
<span class="fc" id="L262">    }</span>

    @Override
    public void visit(VariableRead variableRead) {
<span class="fc" id="L266">        tempValue = currentState.getVariables().get(variableRead.getVariable());</span>
<span class="fc" id="L267">    }</span>

    @Override
    public void visit(ArrayRead arrayRead) {
<span class="fc" id="L271">        Value value = currentState.getVariables().get(arrayRead.getVariable());</span>
<span class="fc" id="L272">        Expression[] indices = arrayRead.getIndices();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        for (Expression index : indices) {</span>
<span class="fc" id="L274">            index.accept(this);</span>
<span class="fc" id="L275">            int pos = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="fc" id="L276">            Value[] values = ((ArrayValue) value).getValues();</span>
<span class="pc bpc" id="L277" title="2 of 4 branches missed.">            if (pos &lt; 0 || pos &gt;= values.length) {</span>
<span class="nc" id="L278">                pos = 0;</span>
            }
<span class="fc" id="L280">            value = values[pos];</span>
        }
<span class="fc" id="L282">        tempValue = value;</span>
<span class="fc" id="L283">    }</span>

    @Override
    public void visit(Function function) {
<span class="fc" id="L287">        currentState.createScope(function.getFunctionBlock(), function);</span>
<span class="fc" id="L288">        FunctionParameter[] params = function.getParameters();</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">        for (int i = 0; i &lt; params.length; i++) {</span>
<span class="fc" id="L290">            Value value = parameters[i];</span>
<span class="fc" id="L291">            String varName = params[i].getName();</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">            if (value instanceof ArrayValue) {</span>
<span class="fc" id="L293">                int depth = 0;</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">                for (Type temp = value.getType(); temp instanceof ArrayType;</span>
<span class="fc" id="L295">                     temp = ((ArrayType) temp).getType()) {</span>
<span class="fc" id="L296">                    depth += 1;</span>
                }
<span class="fc" id="L298">                int[] lengths = new int[depth];</span>
<span class="fc" id="L299">                depth = 0;</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">                for (Value temp = value; temp instanceof ArrayValue;</span>
<span class="fc" id="L301">                     temp = ((ArrayValue) temp).getValues()[0]) {</span>
<span class="fc" id="L302">                    lengths[depth] = ((ArrayValue) temp).getValues().length;</span>
<span class="fc" id="L303">                    depth += 1;</span>
                }
<span class="fc" id="L305">                currentState.createArray(varName, value.getType(), lengths);</span>
<span class="fc" id="L306">                copyArray(varName, value, depth);</span>
            } else {
<span class="fc" id="L308">                currentState.createVar(varName, value.toString(),</span>
<span class="fc" id="L309">                                       value.getType());</span>
            }
        }
<span class="fc" id="L312">        Assumption[] assumptions = function.getAssumptions();</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">        for (Assumption assumption : assumptions) {</span>
<span class="fc" id="L314">            assumption.accept(this);</span>
        }
<span class="fc" id="L316">        adjustStatement();</span>
<span class="fc" id="L317">    }</span>

    /**
     * Copies an array in case of a method call.
     * @param varName new array name
     * @param value array value to copy
     * @param maxDepth depth of the array
     */
    private void copyArray(String varName, Value value, int maxDepth) {
<span class="fc" id="L326">        Integer[] counters = new Integer[maxDepth];</span>
<span class="fc" id="L327">        helpArrayCopy(varName, value, counters, 0);</span>
<span class="fc" id="L328">    }</span>

    /**
     *
     * @param varName new array name
     * @param value array value to copy
     * @param counters counter for current position
     * @param depth depth of the array
     */
    private void helpArrayCopy(String varName, Value value,
                               Integer[] counters, int depth) {
<span class="fc bfc" id="L339" title="All 2 branches covered.">        if (value instanceof ArrayValue) {</span>
<span class="fc" id="L340">            int length = ((ArrayValue) value).getValues().length;</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">            for (int i = 0; i &lt; length; i++) {</span>
<span class="fc" id="L342">                counters[depth] = i;</span>
<span class="fc" id="L343">                helpArrayCopy(varName, ((ArrayValue) value).getValues()[i],</span>
<span class="fc" id="L344">                        counters, depth + 1);</span>
            }
        } else {
<span class="fc" id="L347">            currentState.setArray(varName, value.toString(),</span>
<span class="fc" id="L348">                    Arrays.asList(counters));</span>
        }
<span class="fc" id="L350">    }</span>

    @Override
    public void visit(Program program) {
        //no-op
<span class="nc" id="L355">    }</span>

    @Override
    public void visit(Assignment assignment) {
<span class="fc" id="L359">        assignment.getValue().accept(this);</span>
<span class="fc" id="L360">        currentState.setVar(assignment.getIdentifier().getName(),</span>
<span class="fc" id="L361">                tempValue.toString());</span>
<span class="fc" id="L362">        adjustStatement();</span>
<span class="fc" id="L363">    }</span>

    @Override
    public void visit(Assertion assertion) {
<span class="fc" id="L367">        assertion.getExpression().accept(this);</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">        if (!((BooleanValue) tempValue).getValue()) {</span>
<span class="fc" id="L369">            throw new AssertionFailureException(&quot;Assertion failed!&quot;,</span>
<span class="fc" id="L370">                                                assertion.getPosition());</span>
        }
<span class="fc" id="L372">        adjustStatement();</span>
<span class="fc" id="L373">    }</span>

    @Override
    public void visit(Assumption assumption) {
<span class="fc" id="L377">        assumption.getExpression().accept(this);</span>
<span class="fc bfc" id="L378" title="All 2 branches covered.">        if (!((BooleanValue) tempValue).getValue()) {</span>
<span class="fc" id="L379">            throw new AssertionFailureException(&quot;Assumption failed!&quot;,</span>
<span class="fc" id="L380">                                                assumption.getPosition());</span>
        }
<span class="fc" id="L382">    }</span>

    @Override
    public void visit(Axiom axiom) {
        //not needed in interpreter
<span class="nc" id="L387">    }</span>

    @Override
    public void visit(Ensure ensure) {
<span class="fc" id="L391">        ensure.getExpression().accept(this);</span>
<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (!((BooleanValue) tempValue).getValue()) {</span>
<span class="fc" id="L393">            throw new AssertionFailureException(&quot;Ensure failed!&quot;,</span>
<span class="fc" id="L394">                                                ensure.getPosition());</span>
        }
<span class="fc" id="L396">    }</span>

    @Override
    public void visit(Invariant invariant) {
<span class="fc" id="L400">        invariant.getExpression().accept(this);</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">        if (!((BooleanValue) tempValue).getValue()) {</span>
<span class="fc" id="L402">            throw new AssertionFailureException(&quot;Invariant failed!&quot;,</span>
<span class="fc" id="L403">                                                invariant.getPosition());</span>
        }
<span class="fc" id="L405">    }</span>

    @Override
    public void visit(ReturnStatement returnStatement) {
<span class="fc" id="L409">        returnStatement.getReturnValue().accept(this);</span>
<span class="fc" id="L410">        returnValue = tempValue;</span>
<span class="fc" id="L411">        adjustStatement();</span>
<span class="fc" id="L412">    }</span>

    @Override
    public void visit(VariableDeclaration varDec) {
<span class="fc bfc" id="L416" title="All 2 branches covered.">        if (varDec.getValue() == null) {</span>
<span class="fc" id="L417">            currentState.createVar(varDec.getName(), null, varDec.getType());</span>
        } else {
<span class="fc" id="L419">            varDec.getValue().accept(this);</span>
<span class="fc" id="L420">            currentState.createVar(varDec.getName(),</span>
<span class="fc" id="L421">                        tempValue.toString(), varDec.getType());</span>
        }
<span class="fc" id="L423">        adjustStatement();</span>
<span class="fc" id="L424">    }</span>

    @Override
    public void visit(ArrayDeclaration arrDec) {
<span class="fc" id="L428">        Expression[] indices = arrDec.getIndices();</span>
<span class="fc" id="L429">        int[] lengths = new int[indices.length];</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">        for (int i = 0; i &lt; indices.length; i++) {</span>
<span class="fc" id="L431">            indices[i].accept(this);</span>
<span class="fc" id="L432">            int length = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">            lengths[i] = (length &gt; 0) ? length : 1;</span>
        }
<span class="fc" id="L435">        currentState.createArray(arrDec.getName(), arrDec.getType(), lengths);</span>
<span class="fc" id="L436">        adjustStatement();</span>
<span class="fc" id="L437">    }</span>

    @Override
    public void visit(ExistsQuantifier existsQuantifier) {
<span class="fc" id="L441">        Range range = existsQuantifier.getRange();</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">        if (range != null) {</span>
<span class="fc" id="L443">            range.getLowerBound().accept(this);</span>
<span class="fc" id="L444">            int lower = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="fc" id="L445">            range.getUpperBound().accept(this);</span>
<span class="fc" id="L446">            int upper = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="fc" id="L447">            currentState.createScope(null, null);</span>
<span class="fc" id="L448">            String varName = existsQuantifier.getIdentifier().toString();</span>
<span class="fc" id="L449">            currentState.createVar(varName, null, new IntegerType());</span>
<span class="fc" id="L450">            boolean satisfied = false;</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">            for (int i = lower; i &lt;= upper; i++) {</span>
<span class="fc" id="L452">                currentState.setVar(varName, Integer.toString(i));</span>
<span class="fc" id="L453">                existsQuantifier.getSubexpression1().accept(this);</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">                if (((BooleanValue) tempValue).getValue()) {</span>
                    //found a satisfying value
<span class="fc" id="L456">                    satisfied = true;</span>
                }
            }
<span class="fc" id="L459">            tempValue = new BooleanValue(Boolean.toString(satisfied));</span>
<span class="fc" id="L460">            currentState.destroyScope();</span>
        } else {
<span class="nc" id="L462">            tempValue = new BooleanValue(&quot;true&quot;);</span>
        }
<span class="fc" id="L464">    }</span>

    @Override
    public void visit(ForAllQuantifier forAllQuantifier) {
<span class="fc" id="L468">        Range range = forAllQuantifier.getRange();</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">        if (range != null) {</span>
<span class="fc" id="L470">            range.getLowerBound().accept(this);</span>
<span class="fc" id="L471">            int lower = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="fc" id="L472">            range.getUpperBound().accept(this);</span>
<span class="fc" id="L473">            int upper = ((IntegerValue) tempValue).getValue().intValue();</span>
<span class="fc" id="L474">            currentState.createScope(null, null);</span>
<span class="fc" id="L475">            String varName = forAllQuantifier.getIdentifier().toString();</span>
<span class="fc" id="L476">            currentState.createVar(varName, null, new IntegerType());</span>
<span class="fc" id="L477">            boolean valid = true;</span>
<span class="fc bfc" id="L478" title="All 2 branches covered.">            for (int i = lower; i &lt;= upper; i++) {</span>
<span class="fc" id="L479">                currentState.setVar(varName, Integer.toString(i));</span>
<span class="fc" id="L480">                forAllQuantifier.getSubexpression1().accept(this);</span>
<span class="fc bfc" id="L481" title="All 2 branches covered.">                if (!((BooleanValue) tempValue).getValue()) {</span>
                    //found a counterexample
<span class="fc" id="L483">                    valid = false;</span>
                }
            }
<span class="fc" id="L486">            tempValue = new BooleanValue(Boolean.toString(valid));</span>
<span class="fc" id="L487">            currentState.destroyScope();</span>
        } else {
<span class="fc" id="L489">            tempValue = new BooleanValue(&quot;false&quot;);</span>
        }
<span class="fc" id="L491">    }</span>

    @Override
    public void visit(StatementBlock statementBlock) {
        //not needed
<span class="nc" id="L496">    }</span>

    /**
     * Adjust the statement at the end of a step.
     */
    private void adjustStatement() {
<span class="fc" id="L502">        Function currentFunction = currentState.getCurrentFunction();</span>
<span class="fc" id="L503">        currentState.adjustStatement();</span>
<span class="fc bfc" id="L504" title="All 2 branches covered.">        if (currentState.getCurrentStatement() == null) {</span>
<span class="fc bfc" id="L505" title="All 2 branches covered.">            if (currentState.isFunctionScope()) {</span>
<span class="fc" id="L506">                Ensure[] ensures = currentFunction.getEnsures();</span>
                try {
<span class="fc bfc" id="L508" title="All 2 branches covered.">                    for (Ensure ensure : ensures) {</span>
<span class="fc" id="L509">                        ensure.accept(this);</span>
                    }
<span class="fc" id="L511">                } finally {</span>
<span class="fc" id="L512">                    currentState.destroyScope();</span>
<span class="fc" id="L513">                }</span>
            } else {
<span class="fc" id="L515">                currentState.destroyScope();</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">                if (currentState.getCurrentStatement() instanceof Conditional) {</span>
<span class="fc" id="L517">                    adjustStatement();</span>
                }
            }
        }
<span class="fc" id="L521">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span>Merged (26.02.2012 19:54:06)</div></body></html>