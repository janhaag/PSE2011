<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>EditorView.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Merged (26.02.2012 19:54:06)</a> &gt; <a href="../../index.html" class="el_group">pse</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.html" class="el_package">gui</a> &gt; <span class="el_source">EditorView.java</span></div><h1>EditorView.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package gui;</span>

import org.eclipse.swt.SWT;
import org.eclipse.swt.custom.Bullet;
import org.eclipse.swt.custom.PaintObjectEvent;
import org.eclipse.swt.custom.PaintObjectListener;
import org.eclipse.swt.custom.ST;
import org.eclipse.swt.custom.ScrolledComposite;
import org.eclipse.swt.custom.StyleRange;
import org.eclipse.swt.custom.StyledText;
import org.eclipse.swt.events.SelectionAdapter;
import org.eclipse.swt.events.SelectionEvent;
import org.eclipse.swt.events.SelectionListener;
import org.eclipse.swt.graphics.*;
import org.eclipse.swt.layout.GridData;
import org.eclipse.swt.layout.GridLayout;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.Display;
import org.eclipse.swt.widgets.ScrollBar;

import misc.Editor;
import misc.Keyword;

/**
 * This class represents the editor of the main frame. It displays
 * the source code, receives changes to the source code and statement 
 * breakpoints.
 */
public class EditorView extends Composite {
	/**
	 * model for program code
	 */
	private Editor editor;
	/**
	 * display of the parent composite
	 */
	private Display parentdisplay;
	/**
	 * text field for program code
	 */
	private StyledText textfield;
	/**
	 * text field for line numbers
	 */
	private StyledText linenumbers;
	/**
	 * breakpoint icon
	 */
	private Image breakpoint;
	/**
	 * max number of lines
	 */
	private static final int MAX_LINES = 500;
	
	/**
	 * Construct an editor with the specified parent composite, definitions 
	 * of its style and model.
	 * @param parent specified composite
	 * @param def specified definitions
	 * @param editor specified model
	 */
	public EditorView(Composite parent, int def, Editor editor) {
<span class="nc" id="L63">		super(parent, def);</span>
<span class="nc" id="L64">		this.editor = editor; </span>
<span class="nc" id="L65">		this.editor.setView(this);</span>
<span class="nc" id="L66">		this.parentdisplay = parent.getDisplay();</span>
		
		//Set the Layout
<span class="nc" id="L69">		GridLayout gLayout = new GridLayout();</span>
<span class="nc" id="L70">		gLayout.numColumns = 35;</span>
<span class="nc" id="L71">		gLayout.makeColumnsEqualWidth = true;</span>
<span class="nc" id="L72">		this.setLayout(gLayout);</span>
<span class="nc" id="L73">		GridData gData = new GridData(GridData.FILL_BOTH);</span>
<span class="nc" id="L74">		this.setLayoutData(gData);</span>
		
		//Add text field for line numbers
<span class="nc" id="L77">		final ScrolledComposite sc1 = new ScrolledComposite (this, SWT.V_SCROLL </span>
				| SWT.H_SCROLL | SWT.RIGHT_TO_LEFT);
<span class="nc" id="L79">		this.linenumbers = new StyledText(sc1, SWT.MULTI | SWT.WRAP);	</span>
<span class="nc" id="L80">		sc1.getVerticalBar().setEnabled(false);</span>
<span class="nc" id="L81">		sc1.getHorizontalBar().setEnabled(false);</span>
<span class="nc" id="L82">		this.linenumbers.setSize(35, 7500);</span>
		
<span class="nc" id="L84">		String s = &quot;&quot;;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">		for (int i = 0; i &lt; MAX_LINES - 1; i++) {</span>
<span class="nc" id="L86">			s += &quot; \n&quot;;</span>
		}
<span class="nc" id="L88">		this.linenumbers.setText(s);</span>
		
<span class="nc bnc" id="L90" title="All 2 branches missed.">		for (int i = 0; i &lt; MAX_LINES; i++) {		</span>
<span class="nc" id="L91">			StyleRange style = new StyleRange();</span>
<span class="nc" id="L92">			style.metrics = new GlyphMetrics(0, 0, 25);</span>
<span class="nc" id="L93">			Bullet b = new Bullet(ST.BULLET_TEXT, style);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			if (i &lt; 9) {</span>
<span class="nc" id="L95">				b.text = &quot;   &quot; + (i + 1) + &quot; &quot;;</span>
			}
<span class="nc bnc" id="L97" title="All 2 branches missed.">			else if (i &lt; 99) {</span>
<span class="nc" id="L98">				b.text = &quot;  &quot; + (i + 1) + &quot; &quot;;</span>
			}
			else {
<span class="nc" id="L101">				b.text = (i + 1) + &quot; &quot;;</span>
			}
<span class="nc" id="L103">			this.linenumbers.setLineBullet(i, 1, b);</span>
		}
		
<span class="nc" id="L106">		this.linenumbers.setEditable(false);</span>
<span class="nc" id="L107">		this.linenumbers.setDoubleClickEnabled(false);</span>
<span class="nc" id="L108">		this.linenumbers.setBackground(new Color(this.getDisplay(), 211, 211, 211));</span>
<span class="nc" id="L109">		this.linenumbers.setCursor(new Cursor(parent.getDisplay(), SWT.CURSOR_HAND));</span>
<span class="nc" id="L110">		sc1.setContent(this.linenumbers);</span>
		
		//Add text field for program code
<span class="nc" id="L113">		final ScrolledComposite sc2 = new ScrolledComposite (this, SWT.V_SCROLL | SWT.H_SCROLL);</span>
<span class="nc" id="L114">		this.textfield = new StyledText(sc2, SWT.NONE);</span>
<span class="nc" id="L115">		this.textfield.setLeftMargin(5);</span>
<span class="nc" id="L116">		this.textfield.setSize(1200, 7500);</span>
<span class="nc" id="L117">		this.textfield.setFocus();</span>
<span class="nc" id="L118">		sc2.setContent(this.textfield);</span>
		
		//Position the text fields
<span class="nc" id="L121">		gData = new GridData(GridData.FILL_BOTH);</span>
<span class="nc" id="L122">		gData.horizontalSpan= 3;</span>
<span class="nc" id="L123">		sc1.setLayoutData(gData);</span>
<span class="nc" id="L124">		gData = new GridData(GridData.FILL_BOTH);</span>
<span class="nc" id="L125">		gData.horizontalSpan= 32;</span>
<span class="nc" id="L126">		sc2.setLayoutData(gData);</span>
		
		//Simultaneous scrolling of the text fields
<span class="nc" id="L129">		final ScrollBar vBar1 = sc1.getVerticalBar();</span>
<span class="nc" id="L130">		final ScrollBar vBar2 = sc2.getVerticalBar();</span>
<span class="nc" id="L131">		SelectionListener listener = new SelectionAdapter () {</span>
			public void widgetSelected (SelectionEvent e) {
<span class="nc" id="L133">				int x =  sc1.getOrigin().x;</span>
<span class="nc" id="L134">				int y =  vBar2.getSelection() * (vBar1.getMaximum() - vBar1.getThumb()) </span>
<span class="nc" id="L135">						/ Math.max(1, vBar2.getMaximum() - vBar2.getThumb());</span>
<span class="nc" id="L136">				sc1.setOrigin (x, y);</span>
<span class="nc" id="L137">			}</span>
		};
<span class="nc" id="L139">		vBar2.addSelectionListener(listener); </span>
		
		//Add breakpoint icon
<span class="nc" id="L142">		this.breakpoint = new Image(parentdisplay, </span>
<span class="nc" id="L143">				MainFrame.class.getResourceAsStream(&quot;image/breakpoint.png&quot;)); 		</span>
<span class="nc" id="L144">		this.linenumbers.addPaintObjectListener(new PaintObjectListener() {</span>
	        public void paintObject(PaintObjectEvent event) {
<span class="nc" id="L146">	          GC gc = event.gc;</span>
<span class="nc" id="L147">	          StyleRange style = event.style;</span>
<span class="nc" id="L148">              int x = event.x;</span>
<span class="nc" id="L149">              int y = event.y + event.ascent - style.metrics.ascent;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">              if ((Image)event.style.data != null) {</span>
<span class="nc" id="L151">            	  gc.drawImage((Image)event.style.data, x, y);</span>
              }
<span class="nc" id="L153">	        }</span>
	      }); 
<span class="nc" id="L155">	}</span>
	
	/**
	 * Update the view for undo/redo and syntax highlighting.
	 */
	public void updateView() {
		//Source updates (necessary because of undo/redo functions)
<span class="nc bnc" id="L162" title="All 2 branches missed.">		if(!this.textfield.getText().equals(this.editor.getSource())) {</span>
<span class="nc" id="L163">			this.textfield.setText(editor.getSource());</span>
		}
		//Syntax highlighting
<span class="nc" id="L166">		textfield.setStyleRange(null);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">		for(Keyword word : this.editor.getColorArray()) {</span>
<span class="nc" id="L168">			StyleRange stylerange = new StyleRange();</span>
<span class="nc" id="L169">			stylerange.start = word.getStart();</span>
<span class="nc" id="L170">			stylerange.length = word.getLength();</span>
<span class="nc" id="L171">			stylerange.fontStyle = SWT.BOLD;</span>
<span class="nc" id="L172">			stylerange.foreground = new Color(this.textfield.getDisplay(), word.getColor());</span>
<span class="nc" id="L173">			textfield.setStyleRange(stylerange);</span>
		}
<span class="nc" id="L175">	}</span>
	
	/**
	 * Draw the breakpoint icon in the specified line if set = 1,
	 * otherwise remove the icon.
	 * @param line specified line
	 * @param set if the breakpoint is already set
	 */
	public void setStatementBreakpoint(int line, int set) {	
<span class="nc" id="L184">		StyleRange style = new StyleRange();</span>
<span class="nc" id="L185">		style.start = line * 2 - 2;</span>
<span class="nc" id="L186">		style.length = 1;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if (set == 1) {</span>
<span class="nc" id="L188">			style.data = this.breakpoint;</span>
		}
<span class="nc" id="L190">		Rectangle rect = this.breakpoint.getBounds();</span>
<span class="nc" id="L191">		style.metrics = new GlyphMetrics(rect.height, 0, rect.width);		</span>
<span class="nc" id="L192">		this.linenumbers.setStyleRange(style);</span>
<span class="nc" id="L193">	}</span>
	
	/**
	 * Highlight the specified line with another background color.
	 * @param line specified line
	 */
	public void markLine(int line) {
<span class="nc" id="L200">		this.textfield.setLineBackground(line, 1, new Color(this.parentdisplay, 249, 250, 158));</span>
<span class="nc" id="L201">	}</span>
	
	/**
	 * Remove all line highlighting.
	 */
	public void removeAllLineBackground() {
<span class="nc" id="L207">		this.textfield.setLineBackground(0, this.textfield.getLineCount(), null);</span>
<span class="nc" id="L208">	}</span>
	
	/**
	 * Return the content of the editor text field.
	 * @return editor text
	 */
	public String getText() {
<span class="nc" id="L215">		return this.textfield.getText();</span>
	}
	
	/**
	 * Set the text of the editor text field.
	 * @param text text to be set
	 */
	public void setText(String text) {
<span class="nc" id="L223">		this.textfield.setText(text);</span>
<span class="nc" id="L224">	}</span>
	
	/**
	 * Return the selection of the editor text field.
	 * @return selection of the text field
	 */
	public Point getSelection() {
<span class="nc" id="L231">		return this.textfield.getSelection();</span>
	}
	
	/**
	 * Return the editor text field.
	 * @return editor text field
	 */
	public StyledText getTextField() {
<span class="nc" id="L239">		return this.textfield;</span>
	}
	
	/**
	 * Return the text field for line numbers.
	 * @return line numbers text field
	 */
	public StyledText getLineNumbers() {
<span class="nc" id="L247">		return this.linenumbers;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span>Merged (26.02.2012 19:54:06)</div></body></html>